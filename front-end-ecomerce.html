<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JJ-Commerce</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5; /* Couleur de fond Messenger */
            padding-top: 70px; /* Pour éviter que le contenu ne soit caché par la barre de navigation fixe */
        }

        .messenger-container {
            max-width: 100%; /* Prend toute la largeur disponible */
            margin: 0; /* Supprime le centrage automatique */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        .messenger-header {
            background-color: #0084ff !important; /* Couleur bleue Messenger */
            color: white;
            border-bottom: 1px solid #006acc;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .messenger-header .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        /* Nouveau style pour la zone de contenu principale (sidebar + contenu dynamique) */
        .main-layout-area {
            display: flex;
            flex-grow: 1; /* Permet de prendre l'espace vertical disponible */
            width: 100%; /* S'assure qu'il prend toute la largeur du parent */
        }

        .sidebar {
            width: 220px; /* Largeur fixe pour la barre latérale */
            background-color: #f8f9fa; /* Fond clair pour la barre latérale */
            padding: 20px 15px;
            border-right: 1px solid #eee;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            flex-shrink: 0; /* Empêche la barre latérale de rétrécir */
            overflow-y: auto; /* Permet le défilement si le contenu est long */
        }

        .sidebar-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
            color: #0084ff;
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-nav li {
            margin-bottom: 10px;
        }

        .sidebar-nav a {
            display: block;
            padding: 8px 10px;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .sidebar-nav a:hover {
            background-color: #e0e0e0;
            color: #0084ff;
        }

        .sidebar-nav a i {
            margin-right: 10px;
            color: #666; /* Couleur de l'icône */
        }

        .sidebar-nav a:hover i {
            color: #0084ff; /* Couleur de l'icône au survol */
        }

        .sidebar-nav .separator {
            border-top: 1px solid #eee;
            margin: 15px 0;
        }

        .messenger-body {
            flex-grow: 1; /* Permet au contenu principal de prendre l'espace restant */
            padding: 20px;
            overflow-y: auto;
        }

        /* Style des cartes produits */
        .product-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease-in-out;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-card img {
            height: 200px;
            object-fit: contain;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            padding: 10px;
            background-color: #f8f9fa;
        }

        .product-card .card-body {
            padding: 15px;
        }

        .product-card .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            min-height: 50px;
        }

        .product-card .card-text {
            font-size: 0.9rem;
            color: #666;
            height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .product-card .product-price {
            font-size: 1.4rem;
            font-weight: bold;
            color: #0084ff;
        }

        .product-card .btn-add-to-cart {
            background-color: #0084ff;
            border-color: #0084ff;
            transition: background-color 0.2s;
        }

        .product-card .btn-add-to-cart:hover {
            background-color: #006acc;
            border-color: #006acc;
        }

        /* Styles du panier */
        .cart-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .cart-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-right: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .cart-item-details {
            flex-grow: 1;
        }

        .cart-item-details h6 {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .cart-item-details .text-muted {
            font-size: 0.9em;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
        }

        .cart-item-actions .quantity-input {
            width: 60px;
            text-align: center;
            margin: 0 10px;
        }

        .cart-item-actions .btn-sm {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }

        /* Modale de commande */
        #checkoutForm label {
            font-weight: 500;
        }

        /* Spinner de chargement */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            min-height: 300px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .messenger-container {
                border-radius: 0;
                box-shadow: none;
            }

            .messenger-body {
                padding: 10px;
            }

            .product-card img {
                height: 150px;
            }

            .product-card .card-title {
                font-size: 1rem;
                min-height: auto;
            }

            .product-card .card-text {
                height: auto;
                -webkit-line-clamp: unset;
            }
        }

        /* Style pour la barre de recherche */
        .search-bar-container {
            flex-grow: 1;
            margin-left: 15px;
            margin-right: 15px;
        }

        .search-bar-container .form-control {
            border-radius: 20px;
            padding-left: 1.5rem;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
        }

        .search-bar-container .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-bar-container .form-control:focus {
            background-color: white;
            color: #333;
            box-shadow: none;
        }

        /* Positionnement de l'icône de recherche */
        .search-input-group .fa-search {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            z-index: 5;
        }

        .search-input-group .form-control:focus + .fa-search {
            color: #0084ff;
        }

        @media (max-width: 991.98px) {
            .search-bar-container {
                margin-left: 0;
                margin-right: 0;
                margin-top: 10px;
                width: 100%;
            }
            .navbar-collapse {
                padding-bottom: 10px;
            }
        }

        /* Styles pour les sections statiques (maintenant conditionnelles) */
        .static-sections {
            padding: 20px;
            background-color: #f0f2f5;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .whatsapp-section, .promo-section {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 30px;
        }

        .whatsapp-section h3, .promo-section h3 {
            color: #0084ff;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .whatsapp-section .btn-success {
            background-color: #25D366;
            border-color: #25D366;
            font-size: 1.2rem;
            padding: 10px 25px;
            border-radius: 30px;
            transition: background-color 0.2s ease-in-out;
        }

        .whatsapp-section .btn-success:hover {
            background-color: #1DA851;
            border-color: #1DA851;
        }

        .promo-section img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .messenger-footer {
            background-color: #333;
            color: rgba(255, 255, 255, 0.7);
            padding: 20px;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            font-size: 0.9rem;
        }

        .messenger-footer .fas {
            color: #e74c3c;
        }

        /* Styles pour le carousel */
        .carousel-item img {
            max-height: 300px;
            object-fit: cover;
            width: 100%;
            border-radius: 8px;
        }
        .carousel-caption {
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 10px;
        }

        /* Responsive adjustments for sidebar */
        @media (max-width: 768px) {
            .sidebar {
                display: none; /* Cache la barre latérale sur les petits écrans */
            }
            .main-layout-area {
                flex-direction: column; /* Empile le contenu principal verticalement sur les petits écrans */
            }
        }

        /* Styles pour la section Contacts/Chat */
        .contacts-layout {
            display: flex;
            width: 100%;
            /* Reduced min-height */
            min-height: 400px; /* Adjusted for less height */
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .contacts-list {
            flex-basis: 30%; /* Keep for larger screens */
            max-width: 300px; /* Keep for larger screens */
            background-color: #fff;
            border-right: 1px solid #eee;
            overflow-y: auto;
            padding: 10px 0;
            flex-shrink: 0; /* Prevents shrinking on larger screens */
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f2f5;
            transition: background-color 0.2s ease-in-out;
        }

        .contact-item:hover {
            background-color: #f0f2f5;
        }

        .contact-item.active {
            background-color: #e0e0e0;
        }

        .contact-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .contact-info {
            flex-grow: 1; /* Allows info to take available space */
            overflow: hidden; /* Ensures content within doesn't overflow */
        }

        .contact-info h6 {
            margin-bottom: 0;
            font-weight: 600;
        }

        .contact-info p {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-window {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #f0f2f5; /* Fond du chat */
        }

        .chat-header {
            background-color: #0084ff;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            cursor: pointer; /* Make header clickable */
        }

        .chat-header .back-button {
            display: none; /* Hidden by default on desktop */
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
            cursor: pointer;
        }

        .chat-header img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }

        .chat-header h5 {
            margin-bottom: 0;
            font-weight: bold;
        }

        .chat-header .status-dot {
            width: 10px;
            height: 10px;
            background-color: #25D366; /* Online */
            border-radius: 50%;
            margin-left: 8px;
            display: inline-block;
        }
        .chat-header .status-dot.offline {
            background-color: #ccc; /* Offline */
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            position: relative;
            word-wrap: break-word;
        }

        .message-bubble.me {
            background-color: #0084ff; /* Bleu Messenger */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .message-bubble.other {
            background-color: #e4e6eb; /* Gris clair */
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .message-bubble .message-time {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
            margin-top: 5px;
        }
        .message-bubble.other .message-time {
            color: #666;
        }

        .chat-input-area {
            padding: 15px;
            background-color: #fff;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .chat-input-area .form-control {
            border-radius: 20px;
            margin-right: 10px;
            padding: 10px 15px;
            border: 1px solid #ddd;
        }

        .chat-input-area .btn-primary {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        /* Placeholder pour la fenêtre de chat vide */
        .chat-placeholder {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #aaa;
            text-align: center;
        }
        .chat-placeholder i {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        /* Loading spinner for AI response */
        .ai-loading-bubble {
            background-color: #e4e6eb;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            padding: 10px 15px;
            margin-bottom: 10px;
            max-width: 70%;
            display: flex;
            align-items: center;
        }
        .ai-loading-bubble .spinner-border {
            width: 1.2rem;
            height: 1.2rem;
            margin-right: 10px;
            color: #666;
        }

        /* Mobile specific styles for chat/contacts layout */
        @media (max-width: 768px) {
            .contacts-layout {
                flex-direction: column; /* Stack elements vertically */
                min-height: unset; /* Remove fixed min-height for mobile */
                height: 100%; /* Take full available height */
            }

            .contacts-list {
                width: 100%;
                max-width: none; /* Remove max-width */
                border-right: none;
                border-bottom: 1px solid #eee;
                /* Initially visible */
                display: flex; /* Use flex for contact items */
                flex-direction: column;
            }

            .chat-window {
                width: 100%;
                min-height: 100%; /* Take full height when active */
                /* Initially hidden on mobile */
                display: none;
            }

            /* When a chat is active on mobile, hide the list and show the chat window */
            .contacts-layout.chat-active .contacts-list {
                display: none;
            }

            .contacts-layout.chat-active .chat-window {
                display: flex; /* Show the chat window */
            }

            .chat-header .back-button {
                display: block; /* Show back button on mobile chat header */
            }
        }

        /* Ensure back button is hidden on desktop */
        @media (min-width: 769px) {
            .chat-header .back-button {
                display: none;
            }
        }

        /* Profile page specific styles */
        .profile-card {
            max-width: 600px;
            margin: 20px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .profile-avatar-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 20px auto;
            border: 3px solid #0084ff;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f2f5;
            position: relative;
        }

        .profile-avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-avatar-container .upload-icon {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: #0084ff;
            color: white;
            border-radius: 50%;
            padding: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease;
        }

        .profile-avatar-container .upload-icon:hover {
            background-color: #006acc;
        }

        /* Header profile display */
        .profile-header-display {
            cursor: pointer;
        }
        .profile-header-display img {
            border: 1px solid rgba(255, 255, 255, 0.5);
            width: 30px; /* Reduced size */
            height: 30px; /* Reduced size */
        }

        /* New right sidebar for contact details */
        .contact-details-sidebar {
            width: 280px; /* Fixed width for the sidebar */
            background-color: #f8f9fa;
            border-left: 1px solid #eee;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
            display: none; /* Hidden by default */
            overflow-y: auto;
            /* Optional: Add transition for smooth appearance */
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateX(100%); /* Start off-screen */
        }

        .contact-details-sidebar.active {
            display: block; /* Show when active */
            transform: translateX(0); /* Slide in */
        }

        /* Adjust main layout when sidebar is active */
        .contacts-layout.sidebar-active .chat-window {
            /* Adjust width or flex basis if needed */
            flex-grow: 1; /* Ensure chat window still grows */
        }

        /* Styles for content inside the sidebar */
        .contact-details-sidebar .header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .contact-details-sidebar .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
        }
        .contact-details-sidebar .close-btn:hover {
            color: #333;
        }

        .contact-details-sidebar .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 15px auto;
            border: 3px solid #0084ff;
        }
        .contact-details-sidebar h5 {
            text-align: center;
            margin-bottom: 5px;
            color: #333;
        }
        .contact-details-sidebar .status {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 20px;
        }
        .contact-details-sidebar .info-item {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .contact-details-sidebar .info-item i {
            margin-right: 10px;
            color: #0084ff;
        }
        .contact-details-sidebar .info-item strong {
            color: #333;
        }

        /* Responsive adjustments for sidebar */
        @media (max-width: 992px) { /* Adjust breakpoint if sidebar should be hidden earlier */
            .contact-details-sidebar {
                position: fixed; /* Fixed position on smaller screens */
                top: 70px; /* Below navbar */
                right: 0;
                bottom: 0;
                width: 80%; /* Take more width on smaller screens */
                max-width: 300px; /* Max width for consistency */
                z-index: 1050; /* Above other content but below modals */
                transform: translateX(100%); /* Ensure it's off-screen */
            }
            .contact-details-sidebar.active {
                transform: translateX(0);
            }
            .contacts-layout.sidebar-active .contacts-list,
            .contacts-layout.sidebar-active .chat-window {
                /* On smaller screens, when sidebar is active, hide other parts */
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid messenger-container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top messenger-header">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-store"></i> JJ-Commerce
                </a>
                <div class="search-bar-container d-none d-lg-block">
                    <div class="input-group search-input-group">
                        <input type="search" class="form-control" placeholder="Rechercher un produit..." id="searchInput">
                        <i class="fas fa-search"></i>
                    </div>
                </div>

                <div class="d-flex align-items-center">
                    <div class="profile-header-display d-none d-md-flex align-items-center me-3" id="headerProfileLink">
                        <img id="headerProfileAvatar" src="https://placehold.co/30x30/cccccc/ffffff?text=U" alt="Profile" class="rounded-circle me-2">
                        <span id="headerUsername" class="text-white fw-bold d-none d-lg-block">Utilisateur</span>
                    </div>

                    <button class="btn btn-primary position-relative me-3" id="cartBtn">
                        <i class="fas fa-shopping-cart fa-lg"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCount">
                            0
                            <span class="visually-hidden">articles dans le panier</span>
                        </span>
                    </button>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <div class="search-bar-container d-block d-lg-none mt-3 mb-2">
                        <div class="input-group search-input-group">
                            <input type="search" class="form-control" placeholder="Rechercher un produit..." id="searchInputMobile">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="#" id="homeLink"><i class="fas fa-home"></i> Accueil</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="orderHistoryLink"><i class="fas fa-history"></i> Mes Commandes</a>
                        </li>
                        <li class="nav-item d-md-none">
                            <a class="nav-link" href="#" id="mobileProfileLink"><i class="fas fa-user-circle"></i> Mon Profil</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="main-layout-area">
            <aside class="sidebar d-none d-md-block">
                <div class="sidebar-header">
                    <h4>Menu</h4>
                </div>
                <ul class="sidebar-nav">
                    <li><a href="#" id="sidebarCategoriesLink"><i class="fas fa-th-list"></i> Catégories</a></li>
                    <li><a href="#" id="sidebarFavoritesLink"><i class="fas fa-star"></i> Favoris</a></li>
                    <li class="separator"></li>
                    <li><a href="#" id="sidebarGroupChatsLink"><i class="fas fa-comments"></i> Groupes (Conversations)</a></li>
                    <li><a href="#" id="sidebarGroupManagementLink"><i class="fas fa-users-cog"></i> Gestion des groupes</a></li>
                    <li><a href="#" id="sidebarContactsLink"><i class="fas fa-address-book"></i> Contacts</a></li>
                    <li><a href="#" id="sidebarProfileLink"><i class="fas fa-user-circle"></i> Mon Profil</a></li>
                </ul>
            </aside>

            <div class="messenger-body" id="appContent">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="cartModalLabel"><i class="fas fa-shopping-cart"></i> Votre Panier</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="cartItemsContainer">
                        <p class="text-center text-muted" id="emptyCartMessage">Votre panier est vide.</p>
                    </div>
                    <div class="modal-footer d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Total: <span id="cartTotal">0.00€</span></h5>
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continuer vos achats</button>
                            <button type="button" class="btn btn-success" id="checkoutBtn"><i class="fas fa-cash-register"></i> Passer la commande</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="orderConfirmationModal" tabindex="-1" aria-labelledby="orderConfirmationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="orderConfirmationModalLabel"><i class="fas fa-check-circle"></i> Commande Confirmée !</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p class="lead">Merci pour votre commande !</p>
                        <p>Le paiement se fera sur place, à la livraison.</p>
                        <p>Nous vous contacterons bientôt pour confirmer. Votre numéro de commande est : <strong id="orderNumberDisplay">#XXXXXX</strong></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Récupération des éléments du DOM
            const appContent = document.getElementById('appContent');
            const cartBtn = document.getElementById('cartBtn');
            const cartCount = document.getElementById('cartCount');
            const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
            const cartItemsContainer = document.getElementById('cartItemsContainer');
            const cartTotalElement = document.getElementById('cartTotal');
            const emptyCartMessage = document.getElementById('emptyCartMessage');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const orderConfirmationModal = new bootstrap.Modal(document.getElementById('orderConfirmationModal'));
            const orderNumberDisplay = document.getElementById('orderNumberDisplay');
            const homeLink = document.getElementById('homeLink');
            const orderHistoryLink = document.getElementById('orderHistoryLink');
            const searchInput = document.getElementById('searchInput'); // Barre de recherche desktop
            const searchInputMobile = document.getElementById('searchInputMobile'); // Barre de recherche mobile

            // Sidebar links
            const sidebarCategoriesLink = document.getElementById('sidebarCategoriesLink');
            const sidebarFavoritesLink = document.getElementById('sidebarFavoritesLink');
            const sidebarGroupChatsLink = document.getElementById('sidebarGroupChatsLink'); // New ID for group chats
            const sidebarGroupManagementLink = document.getElementById('sidebarGroupManagementLink'); // New ID for group management
            const sidebarContactsLink = document.getElementById('sidebarContactsLink');
            const sidebarProfileLink = document.getElementById('sidebarProfileLink');

            // Initialisation du panier depuis le localStorage ou un tableau vide
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            // Tableau pour stocker les produits chargés de l'API
            let allProducts = [];

            // Global variable for the sidebar element
            let contactDetailsSidebar = null;


            // Données des contacts (fournies par l'utilisateur)
            const contactsData = {
                "SharonRoseIA": {
                    name: "Sharon Rose IA",
                    avatar: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcST5rQlP8qzJSM7RbZlWnDILzTJWTHptxZh2Q&s",
                    thumbnail: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQvLBpSw3kWG6SFC5mQuTyMezAz0pBBXzXTvYg&s",
                    status: "online",
                    lastMessage: "Posez-moi une question !",
                    isAI: true,
                    messages: [
                        { type: "other", contentType: "text", content: "Bonjour ! Sharon Rose IA. Comment puis-je vous aider aujourd'hui ?", time: "09:00 AM" }
                    ]
                },
                "johnDoe": {
                    name: "Galilée Doe",
                    avatar: "https://randomuser.me/api/portraits/men/50.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/men/60.jpg",
                    status: "online",
                    lastMessage: "Hey, comment vas-tu ?",
                    messages: [
                        { type: "other", contentType: "text", content: "Hey, comment vas-tu ?", time: "11:30 AM" },
                        { type: "me", contentType: "text", content: "Salut ! Je vais super bien, merci !", time: "11:35 AM" },
                        { type: "other", contentType: "text", content: "Cool ! Quoi de neuf de ton côté ?", time: "11:40 AM" },
                        { type: "me", contentType: "text", content: "Pas grand chose, juste du code !", time: "11:45 AM" }
                    ]
                },
                "aliceSmith": {
                    name: "Alice Team",
                    avatar: "https://randomuser.me/api/portraits/women/60.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/women/30.jpg",
                    status: "offline",
                    lastMessage: "Can we meet tomorrow?",
                    messages: [
                        { type: "other", contentType: "text", content: "Salut l'équipe ! On a une réunion à 14h, c'est bon pour tout le monde ?", time: "09:00 AM" },
                        { type: "me", contentType: "text", content: "Oui, c'est OK pour moi ! Je serai là.", time: "09:05 AM" },
                        { type: "other", contentType: "text", content: "Pour moi aussi, pas de souci.", time: "09:07 AM" },
                        { type: "me", contentType: "text", content: "Parfait, à tout à l'heure !", time: "09:10 AM" },
                        { type: "other", contentType: "text", content: "N'oubliez pas les rapports !", time: "09:15 AM" }
                    ]
                },
                "bobJohnson": {
                    name: "Bob Johnson",
                    avatar: "https://randomuser.me/api/portraits/men/66.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/men/66.jpg",
                    status: "online",
                    lastMessage: "Ça marche !",
                    messages: [
                        { type: "other", contentType: "text", content: "Salut ! C'est bon pour ce soir ?", time: "18:00 PM" },
                        { type: "me", contentType: "text", content: "Oui, sans problème. J'arrive vers 19h.", time: "18:05 PM" },
                        { type: "other", contentType: "text", content: "Super, à tout de suite !", time: "18:10 PM" }
                    ]
                },
                "elodieManiema": {
                    name: "Élodie Mbombo",
                    avatar: "https://randomuser.me/api/portraits/women/62.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/women/62.jpg",
                    status: "online",
                    lastMessage: "Le projet avance bien, on a eu le feu vert pour la phase 2 !",
                    messages: [
                        { type: "other", contentType: "text", content: "Salut Élodie, des nouvelles sur le projet 'Lumière pour Tous' ? La réunion de ce matin était cruciale.", time: "09:10 AM" },
                        { type: "me", contentType: "text", content: "Bonjour ! Oui, excellente nouvelle : on a eu le feu vert pour la phase 2 ! Les fonds sont débloqués.", time: "09:15 AM" },
                        { type: "other", contentType: "text", content: "Fantastique ! Bravo à toute l'équipe. Quand peut-on coordonner pour le déploiement ?", time: "09:20 AM" },
                        { type: "me", contentType: "text", content: "Dès que possible. Je t'envoie un doodle pour caler une rencontre cette semaine.", time: "09:25 AM" }
                    ]
                },
                "patrickKivu": {
                    name: "Patrick Kabongo",
                    avatar: "https://randomuser.me/api/portraits/men/63.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/men/63.jpg",
                    status: "offline",
                    lastMessage: "Tu as vu les derniers défis TikTok sur la danse congolaise ?",
                    messages: [
                        { type: "me", contentType: "text", content: "Patrick, t'es là ? Je viens de voir une vidéo de dingue sur TikTok, le nouveau challenge de danse congolaise !", time: "14:00 PM" },
                        { type: "other", contentType: "text", content: "Ah oui ? Envoyez-me le lien, je dois voir ça ! Mon réseau est un peu lent aujourd'hui, haha.", time: "14:15 PM" },
                        { type: "me", contentType: "text", content: "Je t'envoie ça. Faut absolument que tu essaies les pas, c'est contagieux !", time: "14:20 PM" },
                        { type: "other", contentType: "text", content: "Mdr, je suis plus musique que danse, mais je vais regarder ! La prochaine fois on fait un live ensemble.", time: "14:30 PM" }
                    ]
                },
                "graciaKin": {
                    name: "Gracia Ngalula",
                    avatar: "https://randomuser.me/api/portraits/women/69.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/women/69.jpg",
                    status: "online",
                    lastMessage: "La commande de pagnes est prête pour l'expédition.",
                    messages: [
                        { type: "other", contentType: "text", content: "Gracia, bonjour ! Je voulais savoir où en était ma commande de pagnes personnalisés.", time: "10:00 AM" },
                        { type: "me", contentType: "text", content: "Bonjour ! Excellente nouvelle, elle est prête pour l'expédition. Je vous envoie le numéro de suivi dans la foulée.", time: "10:05 AM" },
                        { type: "other", contentType: "text", content: "Parfait ! Merci beaucoup pour votre rapidité. Hâte de les recevoir !", time: "10:10 AM" },
                        { type: "me", contentType: "text", content: "Avec plaisir ! N'hésitez pas si vous avez d'autres besoins. Merci de votre confiance.", time: "10:15 AM" }
                    ]
                },
                "cedricLubum": {
                    name: "Cédric Tshibangu",
                    avatar: "https://randomuser.me/api/portraits/men/65.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/men/65.jpg",
                    status: "online",
                    lastMessage: "La séance de coaching a été très enrichissante.",
                    messages: [
                        { type: "me", contentType: "text", content: "Salut Cédric, merci pour la séance de coaching d'hier. C'était vraiment éclairant pour ma stratégie marketing.", time: "08:30 AM" },
                        { type: "other", contentType: "text", content: "De rien ! Heureux d'avoir pu t'aider. Les retours sont positifs de ton côté ?", time: "08:35 AM" },
                        { type: "me", contentType: "text", content: "Totalement. J'ai déjà commencé à implémenter tes conseils. Je te tiens au courant de l'évolution.", time: "08:40 AM" },
                        { type: "other", contentType: "text", content: "Super ! Reste focalisé sur les objectifs que nous avons définis. À très bientôt !", time: "08:45 AM" }
                    ]
                },
                "christelleKasai": {
                    name: "Christelle Mpiana",
                    avatar: "https://randomuser.me/api/portraits/women/99.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/women/99.jpg",
                    status: "offline",
                    lastMessage: "On se voit au marché central pour la livraison des vivres ?",
                    messages: [
                        { type: "me", contentType: "text", content: "Salut Christelle, tu es disponible demain matin ? On doit organiser la livraison des vivres pour le centre d'accueil.", time: "16:00 PM" },
                        { type: "other", contentType: "text", content: "Oui, je suis libre ! On se donne rendez-vous au marché central à 9h ? On pourra charger directement là-bas.", time: "16:10 PM" },
                        { type: "me", contentType: "text", content: "Parfait pour moi. Je serai là avec l'équipe de bénévoles. Merci pour ton aide habituelle !", time: "16:15 PM" },
                        { type: "other", contentType: "text", content: "Pas de souci, c'est pour la bonne cause. À demain !", time: "16:20 PM" }
                    ]
                },
                "dadiKongo": {
                    name: "Dadi Mputu",
                    avatar: "https://randomuser.me/api/portraits/men/65.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/men/65.jpg",
                    status: "online",
                    lastMessage: "Les résultats du match de l'AS V.Club sont tombés !",
                    messages: [
                        { type: "other", contentType: "text", content: "Alors Dadi, t'as vu le match de V.Club hier soir ? J'ai raté le début, j'étais coincé dans les embouteillages.", time: "07:30 AM" },
                        { type: "me", contentType: "text", content: "Salut ! Oui, j'ai tout suivi. V.Club a cartonné, victoire écrasante ! Les fans sont en folie sur les réseaux.", time: "07:35 AM" },
                        { type: "other", contentType: "text", content: "Ah super ! Je vais revoir les highlights. Tu penses qu'ils vont maintenir ce rythme pour la suite de la saison ?", time: "07:40 AM" },
                        { type: "me", contentType: "text", content: "Clairement ! L'équipe est en forme. On devrait aller au stade ensemble pour le prochain match à domicile.", time: "07:45 AM" }
                    ]
                },
                "giselleNord": {
                    name: "Gisèle Bakonga",
                    avatar: "https://randomuser.me/api/portraits/women/33.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/women/33.jpg",
                    status: "online",
                    lastMessage: "La présentation pour les investisseurs est prête.",
                    messages: [
                        { type: "me", contentType: "text", content: "Gisèle, la présentation pour les investisseurs est finalisée. Je l'ai revue une dernière fois.", time: "11:00 AM" },
                        { type: "other", contentType: "text", content: "Parfait ! Envoie-la moi pour que je puisse la relire avant la réunion de demain. Merci pour ton efficacité.", time: "11:05 AM" },
                        { type: "me", contentType: "text", content: "C'est envoyé. J'espère que ça les convaincra de notre potentiel.", time: "11:10 AM" },
                        { type: "other", contentType: "text", content: "Avec la qualité de ton travail, je suis confiante. À demain !", time: "11:15 AM" }
                    ]
                },
                "jeromeSud": {
                    name: "Jérôme Lusamba",
                    avatar: "https://randomuser.me/api/portraits/men/21.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/men/21.jpg",
                    status: "offline",
                    lastMessage: "La récolte de manioc a été exceptionnelle cette saison.",
                    messages: [
                        { type: "other", contentType: "text", content: "Salut Jérôme, j'espère que la récolte s'est bien passée dans ta ferme.", time: "15:30 PM" },
                        { type: "me", contentType: "text", content: "Bonjour ! Oui, ça a été exceptionnel cette saison, particulièrement pour le manioc ! Dieu merci.", time: "15:35 PM" },
                        { type: "other", contentType: "text", content: "Génial ! C'est une excellente nouvelle pour la communauté. Vous avez prévu une nouvelle distribution ?", time: "15:40 PM" },
                        { type: "me", contentType: "text", content: "Absolument. Nous allons organiser une vente solidaire pour soutenir les familles dans le besoin. Je vous envoie les détails.", time: "15:45 AM" }
                    ]
                },
                "nadineKatanga": {
                    name: "Nadine Tshilombo",
                    avatar: "https://randomuser.me/api/portraits/women/70.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/women/70.jpg",
                    status: "online",
                    lastMessage: "Le nouveau single de Fally Ipupa est une bombe !",
                    messages: [
                        { type: "me", contentType: "text", content: "Nadine, tu as écouté le nouveau single de Fally Ipupa ? C'est une tuerie !", time: "19:00 PM" },
                        { type: "other", contentType: "text", content: "OMG oui ! Je l'ai en boucle depuis ce matin. Il a encore frappé très fort !", time: "19:05 PM" },
                        { type: "me", contentType: "text", content: "Les paroles, le rythme... tout est parfait. C'est le genre de son qui te met direct de bonne humeur.", time: "19:10 PM" },
                        { type: "other", contentType: "text", content: "Exactement ! J'ai déjà partagé avec tous mes contacts. Fally, c'est la légende !", time: "19:15 PM" }
                    ]
                },
                "olivierOrientale": {
                    name: "Olivier Kalala",
                    avatar: "https://randomuser.me/api/portraits/men/82.jpg",
                    thumbnail: "https://randomuser.me/api/portraits/thumb/men/82.jpg",
                    status: "offline",
                    lastMessage: "J'ai besoin de ton avis sur la nouvelle stratégie digitale.",
                    messages: [
                        { type: "other", contentType: "text", content: "Salut Olivier, quand aurais-tu un moment pour discuter de la nouvelle stratégie digitale ? J'ai quelques idées à te soumettre.", time: "13:00 PM" },
                        { type: "me", contentType: "text", content: "Bonjour ! Je suis un peu pris ce matin, mais je suis libre cet après-midi après 15h. Envoie-moi un bref aperçu.", time: "13:10 PM" },
                        { type: "other", contentType: "text", content: "Super ! Je t'envoie ça. Je pense que tes conseils seront précieux pour le déploiement.", time: "13:15 PM" },
                        { type: "me", contentType: "text", content: "Pas de souci. On en parle plus en détail tout à l'heure.", time: "13:20 PM" }
                    ]
                }
            };

            let currentChatContactId = null; // Pour suivre le contact/groupe actuellement ouvert dans le chat
            let currentChatType = null; // 'individual' ou 'group'
            let groupsData = JSON.parse(localStorage.getItem('groupsData')) || {}; // Données des groupes

            // Ajoute des messages de groupe initiaux si les groupes existent et n'ont pas de messages
            if (Object.keys(groupsData).length > 0) {
                for (const groupId in groupsData) {
                    if (groupsData.hasOwnProperty(groupId) && (!groupsData[groupId].messages || groupsData[groupId].messages.length === 0)) {
                        const group = groupsData[groupId];
                        group.messages = []; // S'assure que c'est un tableau

                        // Ajoute des messages d'exemple seulement si le groupe a des membres
                        if (group.members.length > 0) {
                            // Collecte les IDs des membres valides pour les messages "other"
                            const validMemberIds = group.members.filter(memberId => contactsData[memberId]);

                            // Message du premier membre valide (si existe)
                            if (validMemberIds.length > 0) {
                                group.messages.push({ type: "other", senderId: validMemberIds[0], content: "Bonjour à tous ! J'espère que vous allez bien.", time: "10:00 AM" });
                            }
                            // Message de l'utilisateur actuel ("moi")
                            group.messages.push({ type: "me", senderId: "johnDoe", content: "Salut l'équipe ! Ça va super bien, merci.", time: "10:05 AM" });

                            // Message d'un deuxième membre valide différent du premier (si existe)
                            if (validMemberIds.length > 1 && validMemberIds[1] !== validMemberIds[0]) {
                                group.messages.push({ type: "other", senderId: validMemberIds[1], content: "Oui, tout va bien de mon côté aussi. Des nouveautés ?", time: "10:10 AM" });
                            } else if (validMemberIds.length > 0 && validMemberIds[0] !== "johnDoe") {
                                // Fallback: if only one member (not current user), let them send another message
                                group.messages.push({ type: "other", senderId: validMemberIds[0], content: "Oui, tout va bien de mon côté aussi. Des nouveautés ?", time: "10:10 AM" });
                            }
                            // Autre message de l'utilisateur actuel ("moi")
                            group.messages.push({ type: "me", senderId: "johnDoe", content: "Pas grand chose, juste du code !", time: "10:15 AM" });
                        } else {
                            // Si aucun membre, ajoute un message par défaut de "moi"
                            group.messages.push({ type: "me", senderId: "johnDoe", content: "Bienvenue dans ce groupe ! Invitez des membres pour commencer à discuter.", time: "09:00 AM" });
                        }
                    }
                }
                saveGroups(); // Sauvegarde les groupes mis à jour avec les messages
            }


            // --- Fonctions utilitaires ---

            /**
             * Affiche un spinner de chargement dans le contenu principal de l'application.
             */
            function showLoadingSpinner() {
                appContent.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                `;
                console.log('Spinner de chargement affiché.');
            }

            /**
             * Formate un prix en devise (€) avec deux décimales.
             * @param {number} price - Le prix à formater.
             * @returns {string} Le prix formaté.
             */
            function formatPrice(price) {
                return price.toFixed(2) + '€';
            }

            /**
             * Met à jour le nombre d'articles dans l'icône du panier.
             */
            function updateCartCount() {
                cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
                console.log('Compteur du panier mis à jour:', cartCount.textContent);
            }

            /**
             * Calcule le total du panier.
             * @returns {number} Le total des prix des articles dans le panier.
             */
            function calculateCartTotal() {
                const total = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                console.log('Total du panier calculé:', total);
                return total;
            }

            /**
             * Tronque un texte à une longueur maximale et ajoute des points de suspension.
             * @param {string} text - Le texte à tronquer.
             * @param {number} maxLength - La longueur maximale du texte.
             * @returns {string} Le texte tronqué.
             */
            function truncateText(text, maxLength) {
                if (text.length > maxLength) {
                    return text.substring(0, maxLength - 3) + '...';
                }
                return text;
            }

            // --- Fonctions de rendu de l'interface utilisateur ---

            /**
             * Charge et affiche les produits. Peut prendre un tableau de produits filtrés.
             * @param {Array<Object>} [productsToRenderParam=null] - Les produits à afficher. Par défaut, tous les produits.
             */
            async function renderProducts(productsToRenderParam = null) {
                let productsToDisplay = productsToRenderParam;

                if (productsToDisplay === null) {
                    if (allProducts.length === 0) {
                        // Products not yet loaded, fetch them
                        showLoadingSpinner();
                        console.log('Début du chargement des produits depuis l\'API...');
                        try {
                            const response = await fetch('https://fakestoreapi.com/products');
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            allProducts = await response.json(); // Store all fetched products
                            productsToDisplay = allProducts; // Set for display
                            console.log('Produits chargés depuis l\'API:', allProducts.length, 'articles.');
                        } catch (error) {
                            console.error('Erreur lors du chargement des produits depuis l\'API:', error);
                            appContent.innerHTML = `<p class="text-danger text-center">Impossible de charger les produits. Veuillez réessayer plus tard. Erreur: ${error.message}</p>`;
                            return; // Stop execution if fetch fails
                        }
                    } else {
                        // Products already loaded, use them
                        productsToDisplay = allProducts;
                    }
                }

                // Ensure productsToDisplay is an array before proceeding
                if (!Array.isArray(productsToDisplay)) {
                    console.error('productsToDisplay n\'est pas un tableau:', productsToDisplay);
                    appContent.innerHTML = `<p class="text-danger text-center">Une erreur inattendue est survenue lors de l'affichage des produits.</p>`;
                    return;
                }

                let productsHtml = `
                    <div class="alert alert-info text-center" role="alert">
                        Bienvenue sur **JJ-Commerce** ! Découvrez nos offres exclusives.
                    </div>`;

                // Add carousel only if displaying all products (not filtered search results)
                if (productsToRenderParam === null || productsToRenderParam === allProducts) {
                    productsHtml += `
                        <div id="productCarousel" class="carousel slide mb-4" data-bs-ride="carousel" data-bs-interval="5000">
                            <div class="carousel-indicators">
                                <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                                <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                                <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                            </div>
                            <div class="carousel-inner">
                                <div class="carousel-item active">
                                    <img src="https://placehold.co/900x300/FF5733/ffffff?text=Grande+Promotion" class="d-block w-100" alt="Promotion 1">
                                    <div class="carousel-caption d-none d-md-block">
                                        <h5>Offres Flash du Jour !</h5>
                                        <p>Ne manquez pas nos réductions incroyables sur une sélection d'articles.</p>
                                    </div>
                                </div>
                                <div class="carousel-item">
                                    <img src="https://placehold.co/900x300/33FF57/ffffff?text=Nouveautes+Exclusives" class="d-block w-100" alt="Nouveautés">
                                    <div class="carousel-caption d-none d-md-block">
                                        <h5>Découvrez nos Nouveautés</h5>
                                        <p>Les dernières tendances et produits innovants sont arrivés !</p>
                                    </div>
                                </div>
                                <div class="carousel-item">
                                    <img src="https://placehold.co/900x300/3357FF/ffffff?text=Livraison+Gratuite" class="d-block w-100" alt="Livraison Gratuite">
                                    <div class="carousel-caption d-none d-md-block">
                                        <h5>Livraison Gratuite sur toutes les commandes !</h5>
                                        <p>Profitez de nos services de livraison rapide et sans frais.</p>
                                    </div>
                                </div>
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    `;
                }


                productsHtml += `<h2 class="mb-4 text-center"><i class="fas fa-th-large"></i> Nos Derniers Produits</h2>
                                <div class="row">`; // Début de la grille de produits

                // Vérifie si productsToDisplay est vide et ajuste le message.
                if (productsToDisplay.length === 0) {
                    productsHtml += `<p class="text-center text-muted col-12">Aucun produit ne correspond à votre recherche.</p>`;
                } else {
                    productsToDisplay.forEach(product => {
                        productsHtml += `
                            <div class="col-md-4 col-sm-6 mb-4">
                                <div class="card product-card h-100">
                                    <img src="${product.image}" class="card-img-top" alt="${product.title}">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">${product.title}</h5>
                                        <p class="card-text">${product.description}</p>
                                        <div class="mt-auto d-flex justify-content-between align-items-center">
                                            <span class="product-price">${formatPrice(product.price)}</span>
                                            <button class="btn btn-primary btn-add-to-cart" data-product-id="${product.id}">
                                                <i class="fas fa-cart-plus"></i> Ajouter au panier
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                productsHtml += `</div>`; // Fin de la grille de produits

                // Section des catégories (simple visualisation, non fonctionnelle pour le filtrage ici)
                productsHtml += `
                    <div class="mt-5 p-3 bg-light rounded shadow-sm">
                        <h5 class="mb-3"><i class="fas fa-tags"></i> Catégories Populaires</h5>
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge bg-secondary">Électronique</span>
                            <span class="badge bg-secondary">Bijoux</span>
                            <span class="badge bg-secondary">Vêtements Homme</span>
                            <span class="badge bg-secondary">Vêtements Femme</span>
                            <span class="badge bg-secondary">Articles de Maison</span>
                            <span class="badge bg-secondary">Sport & Loisirs</span>
                        </div>
                    </div>
                `;

                // Sections statiques et footer ajoutés ici (conditionnellement)
                productsHtml += `
                    <div class="static-sections p-4 mt-5">
                        <section class="whatsapp-section text-center mb-5 p-4">
                            <h3><i class="fab fa-whatsapp"></i> Nous Contacter sur WhatsApp</h3>
                            <p class="lead">Besoin d'aide ou d'informations ? Contactez-nous directement pour une assistance rapide !</p>
                            <a href="https://wa.me/243812345678" target="_blank" class="btn btn-success btn-lg">
                                <i class="fab fa-whatsapp"></i> Envoyer un message
                            </a>
                        </section>

                        <section class="promo-section text-center mb-5 p-4">
                            <h3><i class="fas fa-bullhorn"></i> Nos Offres Spéciales !</h3>
                            <p>Profitez de réductions incroyables sur une sélection d'articles. Ne manquez pas nos promotions exclusives !</p>
                            <img src="https://placehold.co/600x200/0084ff/ffffff?text=Publicite+JJ-Commerce" alt="Publicité JJ-Commerce" class="img-fluid rounded mb-3">
                            <p class="text-muted">Offre limitée ! Visitez notre boutique pour en savoir plus.</p>
                        </section>
                    </div>

                    <footer class="messenger-footer text-center mt-auto">
                        <p>&copy; 2024 JJ-Commerce. Tous droits réservés.</p>
                        <p>Développé avec <i class="fas fa-heart text-danger"></i> pour vous.</p>
                    </footer>
                `;

                appContent.innerHTML = productsHtml; // Injecte le HTML dans le DOM
                attachAddToCartListeners(); // Attache les écouteurs d'événements aux boutons "Ajouter au panier"
                hideContactDetailsSidebar(); // Ensure sidebar is hidden when rendering products
                console.log('Produits affichés sur la page d\'accueil (filtrés si applicable).');
            }

            /**
             * Attache les écouteurs d'événements aux boutons "Ajouter au panier".
             */
            function attachAddToCartListeners() {
                document.querySelectorAll('.btn-add-to-cart').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productId = parseInt(event.currentTarget.dataset.productId);
                        addProductToCart(productId);
                    });
                });
                console.log('Écouteurs "Ajouter au panier" attachés.');
            }

            /**
             * Affiche les articles du panier dans la modale du panier.
             */
            function renderCartItems() {
                cartItemsContainer.innerHTML = ''; // Vide le conteneur actuel
                console.log('Rendu des articles du panier. Panier actuel:', cart);
                if (cart.length === 0) {
                    emptyCartMessage.style.display = 'block'; // Affiche le message "panier vide"
                    checkoutBtn.disabled = true; // Désactive le bouton de commande
                    console.log('Panier vide, message affiché.');
                } else {
                    emptyCartMessage.style.display = 'none'; // Cache le message "panier vide"
                    checkoutBtn.disabled = false; // Active le bouton de commande
                    // Génère le HTML pour chaque article du panier
                    cart.forEach(item => {
                        const cartItemHtml = `
                            <div class="cart-item" data-product-id="${item.id}">
                                <img src="${item.image}" alt="${item.title}">
                                <div class="cart-item-details">
                                    <h6>${item.title}</h6>
                                    <p class="text-muted mb-1">${formatPrice(item.price)}</p>
                                    <p class="text-muted">Sous-total: ${formatPrice(item.price * item.quantity)}</p>
                                </div>
                                <div class="cart-item-actions">
                                    <button class="btn btn-outline-secondary btn-sm decrease-quantity"><i class="fas fa-minus"></i></button>
                                    <input type="number" class="form-control form-control-sm quantity-input" value="${item.quantity}" min="1" readonly>
                                    <button class="btn btn-outline-secondary btn-sm increase-quantity"><i class="fas fa-plus"></i></button>
                                    <button class="btn btn-danger btn-sm ms-2 remove-from-cart"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        `;
                        cartItemsContainer.insertAdjacentHTML('beforeend', cartItemHtml);
                    });
                    attachCartItemListeners(); // Attache les écouteurs d'événements aux boutons du panier
                    console.log('Articles du panier affichés.');
                }
                cartTotalElement.textContent = formatPrice(calculateCartTotal()); // Met à jour le total
                updateCartCount(); // Met à jour le compteur du panier
            }

            /**
             * Attache les écouteurs d'événements aux boutons de quantité et de suppression dans le panier.
             */
            function attachCartItemListeners() {
                cartItemsContainer.querySelectorAll('.increase-quantity').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productId = parseInt(event.target.closest('.cart-item').dataset.productId);
                        changeQuantity(productId, 1);
                    });
                });

                cartItemsContainer.querySelectorAll('.decrease-quantity').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productId = parseInt(event.target.closest('.cart-item').dataset.productId);
                        changeQuantity(productId, -1);
                    });
                });

                cartItemsContainer.querySelectorAll('.remove-from-cart').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productId = parseInt(event.target.closest('.cart-item').dataset.productId);
                        removeProductFromCart(productId);
                    });
                });
                console.log('Écouteurs d\'événements du panier attachés.');
            }

            /**
             * Affiche le formulaire de commande.
             */
            function renderCheckoutForm() {
                appContent.innerHTML = `
                    <h2 class="mb-4 text-center"><i class="fas fa-cash-register"></i> Passer votre commande</h2>
                    <div class="card p-4 shadow-sm">
                        <form id="checkoutForm">
                            <div class="mb-3">
                                <label for="fullName" class="form-label">Nom complet</label>
                                <input type="text" class="form-control" id="fullName" required>
                            </div>
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">Numéro de téléphone</label>
                                <input type="tel" class="form-control" id="phoneNumber" placeholder="Ex: +243 812345678" required>
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">Adresse de livraison</label>
                                <textarea class="form-control" id="address" rows="3" required></textarea>
                            </div>
                            <hr>
                            <h5 class="mb-3">Récapitulatif de la commande</h5>
                            <ul class="list-group mb-3" id="orderSummaryList">
                                </ul>
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5>Total à payer sur place:</h5>
                                <h4 class="text-primary" id="finalOrderTotal">${formatPrice(calculateCartTotal())}</h4>
                            </div>
                            <p class="text-muted text-center"><i class="fas fa-info-circle"></i> Le paiement se fera en espèces sur place à la livraison.</p>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg"><i class="fas fa-paper-plane"></i> Confirmer la commande</button>
                                <button type="button" class="btn btn-outline-secondary" id="backToCartBtn"><i class="fas fa-arrow-left"></i> Retour au panier</button>
                            </div>
                        </form>
                    </div>
                `;
                renderOrderSummary(); // Affiche le récapitulatif des articles
                document.getElementById('checkoutForm').addEventListener('submit', handleCheckoutSubmit); // Attache l'écouteur de soumission du formulaire
                document.getElementById('backToCartBtn').addEventListener('click', () => {
                    appContent.innerHTML = ''; // Vide le contenu
                    renderProducts(); // Retourne à la page des produits
                    cartModal.show(); // Ouvre la modale du panier
                });
                hideContactDetailsSidebar(); // Ensure sidebar is hidden when rendering checkout form
                console.log('Formulaire de commande affiché.');
            }

            /**
             * Affiche le récapitulatif des articles dans le formulaire de commande.
             */
            function renderOrderSummary() {
                const orderSummaryList = document.getElementById('orderSummaryList');
                orderSummaryList.innerHTML = '';
                cart.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                    listItem.innerHTML = `
                        ${item.title} x ${item.quantity}
                        <span class="badge bg-primary rounded-pill">${formatPrice(item.price * item.quantity)}</span>
                    `;
                    orderSummaryList.appendChild(listItem);
                });
                console.log('Récapitulatif de la commande affiché.');
            }

            /**
             * Affiche l'historique des commandes stockées localement.
             */
            function renderOrderHistory() {
                showLoadingSpinner(); // Affiche le spinner pendant le chargement
                const orders = JSON.parse(localStorage.getItem('orderHistory')) || [];
                console.log('Rendu de l\'historique des commandes. Commandes trouvées:', orders.length);

                if (orders.length === 0) {
                    appContent.innerHTML = `
                        <div class="text-center p-5">
                            <i class="fas fa-box-open fa-5x text-muted mb-3"></i>
                            <h3 class="text-muted">Vous n'avez pas encore passé de commande.</h3>
                            <p>Commencez vos achats dès maintenant !</p>
                            <button class="btn btn-primary mt-3" id="startShoppingBtn"><i class="fas fa-store"></i> Retour à la boutique</button>
                        </div>
                    `;
                    // Utiliser une fonction fléchée pour s'assurer que renderProducts est appelée sans arguments
                    document.getElementById('startShoppingBtn').addEventListener('click', () => renderProducts());
                    console.log('Historique des commandes vide, message affiché.');
                    return;
                }

                let orderHistoryHtml = `
                    <h2 class="mb-4 text-center"><i class="fas fa-history"></i> Votre Historique de Commandes</h2>
                    <div class="accordion" id="orderAccordion">
                `;
                // Génère le HTML pour chaque commande dans l'historique
                orders.forEach((order, index) => {
                    orderHistoryHtml += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                                    Commande #${order.orderId} - ${new Date(order.timestamp).toLocaleString()}
                                    <span class="ms-auto badge bg-success">Total: ${formatPrice(order.total)}</span>
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}" data-bs-parent="#orderAccordion">
                                <div class="accordion-body">
                                    <h6>Détails du client:</h6>
                                    <p><strong>Nom:</strong> ${order.customer.fullName}</p>
                                    <p><strong>Téléphone:</strong> ${order.customer.phoneNumber}</p>
                                    <p><strong>Adresse:</strong> ${order.customer.address}</p>
                                    <h6>Articles commandés:</h6>
                                    <ul class="list-group mb-3">
                                        ${order.items.map(item => `
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                ${item.title} x ${item.quantity}
                                                <span class="badge bg-secondary rounded-pill">${formatPrice(item.price * item.quantity)}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                    <p class="text-end fw-bold">Grand Total: ${formatPrice(order.total)}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                orderHistoryHtml += '</div>';
                appContent.innerHTML = orderHistoryHtml; // Injecte le HTML dans le DOM
                hideContactDetailsSidebar(); // Ensure sidebar is hidden when rendering order history
                console.log('Historique des commandes affiché.');
            }


            // --- Fonctions de logique du panier ---

            /**
             * Ajoute un produit au panier ou augmente sa quantité s'il est déjà présent.
             * @param {number} productId - L'ID du produit à ajouter.
             */
            function addProductToCart(productId) {
                const product = allProducts.find(p => p.id === productId); // Utilise allProducts
                if (!product) {
                    console.warn('Produit non trouvé pour l\'ajout au panier:', productId);
                    return; // Si le produit n'est pas trouvé, ne rien faire
                }

                const existingItem = cart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity++; // Incrémente la quantité
                    console.log('Quantité du produit existant augmentée:', existingItem);
                } else {
                    cart.push({ ...product, quantity: 1 }); // Ajoute le produit avec une quantité de 1
                    console.log('Nouveau produit ajouté au panier:', product);
                }
                localStorage.setItem('cart', JSON.stringify(cart)); // Sauvegarde le panier dans le localStorage
                updateCartCount(); // Met à jour le compteur
                showToast('Article ajouté au panier !', 'success'); // Affiche une notification
            }

            /**
             * Modifie la quantité d'un article dans le panier.
             * @param {number} productId - L'ID du produit.
             * @param {number} delta - La valeur à ajouter ou soustraire à la quantité (ex: 1 pour augmenter, -1 pour diminuer).
             */
            function changeQuantity(productId, delta) {
                const itemIndex = cart.findIndex(item => item.id === productId);
                if (itemIndex > -1) {
                    cart[itemIndex].quantity += delta;
                    if (cart[itemIndex].quantity <= 0) {
                        removeProductFromCart(productId); // Supprime l'article si la quantité est <= 0
                        console.log('Article retiré du panier car quantité <= 0:', productId);
                    } else {
                        localStorage.setItem('cart', JSON.stringify(cart));
                        renderCartItems(); // Re-rend le panier pour refléter le changement
                        console.log('Quantité modifiée pour le produit:', productId, 'nouvelle quantité:', cart[itemIndex].quantity);
                    }
                } else {
                    console.warn('Impossible de modifier la quantité, article non trouvé dans le panier:', productId);
                }
            }

            /**
             * Retire un produit du panier.
             * @param {number} productId - L'ID du produit à retirer.
             */
            function removeProductFromCart(productId) {
                cart = cart.filter(item => item.id !== productId); // Filtre le panier pour retirer l'article
                localStorage.setItem('cart', JSON.stringify(cart)); // Sauvegarde le panier
                renderCartItems(); // Re-rend le panier
                showToast('Article retiré du panier.', 'info'); // Affiche une notification
                console.log('Produit retiré du panier:', productId);
            }

            // --- Gestion de la commande ---

            /**
             * Gère la soumission du formulaire de commande.
             * @param {Event} event - L'événement de soumission du formulaire.
             */
            async function handleCheckoutSubmit(event) {
                event.preventDefault(); // Empêche le rechargement de la page
                console.log('Soumission du formulaire de commande...');

                // Récupération des données du formulaire
                const fullName = document.getElementById('fullName').value;
                const phoneNumber = document.getElementById('phoneNumber').value;
                const address = document.getElementById('address').value;

                if (cart.length === 0) {
                    showToast('Votre panier est vide. Veuillez ajouter des articles.', 'warning');
                    console.warn('Tentative de commande avec un panier vide.');
                    return;
                }

                // Création de l'objet de détails de la commande
                const orderDetails = {
                    orderId: 'ORD-' + Math.random().toString(36).substr(2, 9).toUpperCase(), // Génère un ID unique
                    timestamp: new Date().toISOString(), // Date et heure de la commande
                    customer: {
                        fullName: fullName,
                        phoneNumber: phoneNumber,
                        address: address
                    },
                    items: cart.map(item => ({ // Mappe les articles du panier pour l'historique
                        id: item.id,
                        title: item.title,
                        price: item.price,
                        quantity: item.quantity,
                        image: item.image
                    })),
                    total: calculateCartTotal(),
                    paymentStatus: 'pending_on_delivery' // Indique que le paiement est sur place
                };
                console.log('Détails de la commande préparés:', orderDetails);

                // Simuler l'envoi de la commande à un backend (ici, via Fake Store API POST)
                // Dans un environnement réel, cette requête serait envoyée à votre API WooCommerce.
                try {
                    // Envoyer un produit générique comme simulation de commande à Fake Store API.
                    // La Fake Store API ne gère pas de vraies commandes, c'est une démonstration.
                    const dummyOrderProduct = {
                        title: `Commande JJ-Commerce #${orderDetails.orderId} de ${fullName}`,
                        price: orderDetails.total,
                        description: `Articles: ${orderDetails.items.map(item => `${item.title} x ${item.quantity}`).join(', ')}. Téléphone: ${phoneNumber}. Adresse: ${address}.`,
                        image: 'https://placehold.co/600x400/0084ff/ffffff?text=JJ-Commerce+Order', // Image générique pour la simulation
                        category: 'orders'
                    };

                    const response = await fetch('https://fakestoreapi.com/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dummyOrderProduct)
                    });

                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Commande simulée envoyée à Fake Store API:', data);

                    // Simuler l'envoi d'e-mail au propriétaire
                    // C'est une simulation côté client. Dans un vrai backend, vous utiliseriez un service d'envoi d'e-mail.
                    console.log(`
                        --- NOTIFICATION PAR EMAIL (SIMULÉE) ---
                        À: proprietaire@domaine.com
                        Sujet: Nouvelle commande JJ-Commerce #${orderDetails.orderId} reçue !
                        Contenu:
                        Un utilisateur a passé une nouvelle commande sur JJ-Commerce :
                        Nom: ${fullName}
                        Téléphone: ${phoneNumber}
                        Adresse: ${address}
                        Total: ${formatPrice(orderDetails.total)}
                        Articles:
                        ${orderDetails.items.map(item => `- ${item.title} x ${item.quantity} (${formatPrice(item.price)})`).join('\n')}
                        --- FIN DE NOTIFICATION (SIMULÉE) ---
                    `);

                    // Stocker la commande dans l'historique local du navigateur
                    const orderHistory = JSON.parse(localStorage.getItem('orderHistory')) || [];
                    orderHistory.push(orderDetails);
                    localStorage.setItem('orderHistory', JSON.stringify(orderHistory));
                    console.log('Commande ajoutée à l\'historique local.');


                    // Afficher la modale de confirmation
                    orderNumberDisplay.textContent = orderDetails.orderId;
                    orderConfirmationModal.show();
                    console.log('Modale de confirmation de commande affichée.');

                    // Vider le panier après la commande
                    cart = [];
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartCount(); // Met à jour le compteur du panier
                    renderCartItems(); // Met à jour la modale du panier (qui sera fermée par la suite)
                    console.log('Panier vidé.');

                    // Rediriger vers la page d'accueil après un court délai pour la confirmation
                    setTimeout(() => {
                        orderConfirmationModal.hide(); // Cache la modale de confirmation
                        renderProducts(); // Revenir à la page des produits
                        console.log('Redirection vers la page d\'accueil après confirmation.');
                    }, 3000);

                } catch (error) {
                    console.error('Erreur lors de la confirmation de commande ou de l\'envoi simulé:', error);
                    showToast('Une erreur est survenue lors de la commande. Veuillez réessayer.', 'danger');
                }
            }


            // --- Toasts (Notifications) ---
            /**
             * Affiche une notification "toast" en bas à droite de l'écran.
             * @param {string} message - Le message à afficher.
             * @param {string} type - Le type de toast (ex: 'success', 'info', 'warning', 'danger').
             */
            function showToast(message, type = 'info') {
                // Crée le conteneur de toasts s'il n'existe pas
                const toastContainer = document.querySelector('.toast-container') || (() => {
                    const div = document.createElement('div');
                    div.classList.add('toast-container', 'position-fixed', 'bottom-0', 'end-0', 'p-3');
                    document.body.appendChild(div);
                    return div;
                })();

                // Génère le HTML du toast
                const toastHtml = `
                    <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                toastContainer.insertAdjacentHTML('beforeend', toastHtml); // Ajoute le toast au conteneur
                const toastEl = toastContainer.lastElementChild; // Récupère l'élément toast
                const toast = new bootstrap.Toast(toastEl); // Initialise le composant Bootstrap Toast
                toast.show(); // Affiche le toast
                // Supprime le toast du DOM une fois qu'il est caché
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
                console.log('Toast affiché:', message, type);
            }

            /**
             * Filtre les produits en fonction de la chaîne de recherche et les affiche.
             * @param {string} query - La chaîne de recherche.
             */
            function filterProducts(query) {
                const lowerCaseQuery = query.toLowerCase();
                const filtered = allProducts.filter(product =>
                    product.title.toLowerCase().includes(lowerCaseQuery) ||
                    product.description.toLowerCase().includes(lowerCaseQuery) ||
                    product.category.toLowerCase().includes(lowerCaseQuery)
                );
                renderProducts(filtered);
                console.log(`Produits filtrés pour la recherche "${query}":`, filtered.length, 'articles.');
            }

            // Function to toggle between contact list and chat window on mobile
            function toggleChatView(showChatWindow = false) {
                const contactsLayout = document.querySelector('.contacts-layout');
                if (!contactsLayout) return; // Exit if layout not rendered yet

                if (window.innerWidth <= 768) { // Only apply on mobile
                    if (showChatWindow) {
                        contactsLayout.classList.add('chat-active');
                    } else {
                        contactsLayout.classList.remove('chat-active');
                    }
                }
            }

            // --- Fonctions de la section Contacts/Chat ---

            /**
             * Affiche la liste des contacts.
             */
            function renderContacts() {
                toggleChatView(false); // Ensure list is visible on mobile when rendering contacts
                appContent.innerHTML = `
                    <h2 class="mb-4 text-center"><i class="fas fa-address-book"></i> Vos Contacts</h2>
                    <div class="contacts-layout">
                        <div class="contacts-list" id="contactsList">
                            </div>
                        <div class="chat-window" id="chatWindow">
                            <div class="chat-placeholder">
                                <i class="fas fa-comments"></i>
                                <h3>Sélectionnez un contact pour commencer à discuter</h3>
                                <p>Vos conversations s'afficheront ici.</p>
                            </div>
                        </div>
                        <div class="contact-details-sidebar" id="contactDetailsSidebar">
                            </div>
                    </div>
                `;
                // Get the sidebar element once DOM is loaded for the chat view
                contactDetailsSidebar = document.getElementById('contactDetailsSidebar');
                hideContactDetailsSidebar(); // Ensure it's hidden initially for this view

                const contactsListElement = document.getElementById('contactsList');
                Object.keys(contactsData).forEach(contactId => {
                    const contact = contactsData[contactId];
                    const contactItemHtml = `
                        <div class="contact-item" data-contact-id="${contactId}">
                            <img src="${contact.thumbnail}" alt="${contact.name}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/cccccc/ffffff?text=${contact.name.charAt(0)}'">
                            <div class="contact-info">
                                <h6>${contact.name}</h6>
                                <p>${truncateText(contact.lastMessage, 50)}</p>
                            </div>
                        </div>
                    `;
                    contactsListElement.insertAdjacentHTML('beforeend', contactItemHtml);
                });

                // Attacher les écouteurs d'événements aux éléments de contact
                document.querySelectorAll('.contact-item').forEach(item => {
                    item.addEventListener('click', (event) => {
                        const selectedContactId = event.currentTarget.dataset.contactId;
                        renderChatWindow(selectedContactId);

                        // Mettre à jour la classe active
                        document.querySelectorAll('.contact-item').forEach(c => c.classList.remove('active'));
                        event.currentTarget.classList.add('active');
                    });
                });
                console.log('Liste des contacts affichée.');
            }

            /**
             * Affiche la fenêtre de chat pour un contact donné.
             * @param {string} contactId - L'ID du contact à afficher.
             */
            function renderChatWindow(contactId) {
                currentChatContactId = contactId;
                currentChatType = 'individual';
                const contact = contactsData[contactId];
                const chatWindowElement = document.getElementById('chatWindow');

                if (!contact) {
                    chatWindowElement.innerHTML = `<p class="text-danger text-center">Contact non trouvé.</p>`;
                    return;
                }

                chatWindowElement.innerHTML = `
                    <div class="chat-header" id="chatHeader"> <button class="back-button" id="backToContactsListBtn"><i class="fas fa-arrow-left"></i></button>
                        <img src="${contact.avatar}" alt="${contact.name}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/0084ff/ffffff?text=${contact.name.charAt(0)}'">
                        <h5 id="chatHeaderName">${contact.name}
                            <span class="status-dot ${contact.status === 'offline' ? 'offline' : ''}"></span>
                        </h5>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        </div>
                    <div class="chat-input-area">
                        <input type="text" class="form-control" placeholder="Écrire un message..." id="messageInput">
                        <button class="btn btn-primary" id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                `;

                const chatMessagesElement = document.getElementById('chatMessages');
                const messageInput = document.getElementById('messageInput');
                const sendMessageBtn = document.getElementById('sendMessageBtn');
                const backToContactsListBtn = document.getElementById('backToContactsListBtn');
                const chatHeaderElement = document.getElementById('chatHeader'); // Get the chat header element

                backToContactsListBtn.addEventListener('click', () => {
                    renderContacts(); // Go back to the contacts list
                    hideContactDetailsSidebar(); // Hide sidebar when going back
                });

                // Add event listener to the chat header for contact details
                chatHeaderElement.addEventListener('click', (event) => {
                    // Ensure click is not on the back button
                    if (!event.target.closest('.back-button')) {
                        showContactDetailsSidebar(contactId);
                    }
                });


                // Afficher les messages existants
                contact.messages.forEach(msg => {
                    displayMessage(msg.type, msg.content, msg.time, chatMessagesElement);
                });
                scrollToBottom(chatMessagesElement);

                // Écouteur pour envoyer un message
                sendMessageBtn.addEventListener('click', () => {
                    sendMessage(messageInput.value, contactId, chatMessagesElement, messageInput);
                });

                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage(messageInput.value, contactId, chatMessagesElement, messageInput);
                    }
                });

                toggleChatView(true); // Activate chat view on mobile
                hideContactDetailsSidebar(); // Ensure sidebar is hidden when a new chat opens
                console.log('Fenêtre de chat affichée pour le contact:', contact.name);
            }

            /**
             * Affiche un message dans la fenêtre de chat.
             * @param {string} type - 'me' ou 'other'.
             * @param {string} content - Le contenu du message.
             * @param {string} time - L'heure du message.
             * @param {HTMLElement} chatMessagesElement - L'élément conteneur des messages.
             * @param {string} [senderName=null] - Le nom de l'expéditeur (pour les chats de groupe).
             */
            function displayMessage(type, content, time, chatMessagesElement, senderName = null) {
                const messageHtml = `
                    <div class="message-bubble ${type}">
                        ${senderName ? `<small class="fw-bold d-block mb-1">${senderName}</small>` : ''}
                        ${content}
                        <div class="message-time">${time}</div>
                    </div>
                `;
                chatMessagesElement.insertAdjacentHTML('beforeend', messageHtml);
            }

            /**
             * Envoie un message et le gère (ajout au modèle, affichage, et potentiellement appel IA).
             * @param {string} messageText - Le texte du message à envoyer.
             * @param {string} contactId - L'ID du contact.
             * @param {HTMLElement} chatMessagesElement - L'élément conteneur des messages.
             * @param {HTMLInputElement} messageInput - L'élément input du message.
             */
            async function sendMessage(messageText, contactId, chatMessagesElement, messageInput) {
                if (messageText.trim() === '') return;

                const contact = contactsData[contactId];
                const currentTime = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                // Ajouter le message de l'utilisateur
                const userMessage = { type: "me", contentType: "text", content: messageText.trim(), time: currentTime };
                contact.messages.push(userMessage);
                displayMessage(userMessage.type, userMessage.content, userMessage.time, chatMessagesElement);
                contact.lastMessage = messageText.trim(); // Mettre à jour le dernier message

                messageInput.value = ''; // Vider l'input
                scrollToBottom(chatMessagesElement);

                // Si c'est l'IA, appeler l'API Gemini
                if (contact.isAI) {
                    const loadingBubble = document.createElement('div');
                    loadingBubble.classList.add('ai-loading-bubble');
                    loadingBubble.innerHTML = `<div class="spinner-border" role="status"><span class="visually-hidden">Chargement...</span></div><span>L'IA est en train d'écrire...</span>`;
                    chatMessagesElement.appendChild(loadingBubble);
                    scrollToBottom(chatMessagesElement);

                    try {
                        const aiResponse = await sendMessageToGemini(messageText, contact.messages);
                        loadingBubble.remove(); // Supprimer le spinner
                        const aiMessage = { type: "other", contentType: "text", content: aiResponse, time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) };
                        contact.messages.push(aiMessage);
                        displayMessage(aiMessage.type, aiMessage.content, aiMessage.time, chatMessagesElement);
                        contact.lastMessage = aiResponse; // Mettre à jour le dernier message
                    } catch (error) {
                        console.error('Erreur lors de la communication avec Gemini:', error);
                        loadingBubble.remove();
                        const errorMessage = { type: "other", contentType: "text", content: "Désolé, je n'ai pas pu générer de réponse. Veuillez réessayer.", time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) };
                        contact.messages.push(errorMessage);
                        displayMessage(errorMessage.type, errorMessage.content, errorMessage.time, chatMessagesElement);
                        contact.lastMessage = "Erreur de communication avec l'IA.";
                    }
                    scrollToBottom(chatMessagesElement);
                }
            }

            /**
             * Fait défiler la fenêtre de chat jusqu'en bas.
             * @param {HTMLElement} element - L'élément à faire défiler.
             */
            function scrollToBottom(element) {
                element.scrollTop = element.scrollHeight;
            }

            /**
             * Envoie un message à l'API Gemini et retourne la réponse.
             * @param {string} prompt - Le message de l'utilisateur.
             * @param {Array<Object>} chatHistory - L'historique complet de la conversation.
             * @returns {Promise<string>} La réponse de l'IA.
             */
            async function sendMessageToGemini(prompt, chatHistory) {
                let formattedChatHistory = chatHistory.map(msg => ({
                    role: msg.type === "me" ? "user" : "model",
                    parts: [{ text: msg.content }]
                }));

                // Assurez-vous que le dernier message est toujours de l'utilisateur pour le prompt actuel
                formattedChatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: formattedChatHistory };
                const apiKey = ""; // Laisser vide, Canvas fournira la clé en runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Structure de réponse inattendue de Gemini:", result);
                    throw new Error("Réponse vide ou inattendue de l'IA.");
                }
            }

            // --- Fonctions de la section Groupes ---
            function saveGroups() {
                localStorage.setItem('groupsData', JSON.stringify(groupsData));
                console.log('Groupes sauvegardés:', groupsData);
            }

            /**
             * Affiche la section de gestion des groupes (création, ajout/suppression de membres).
             */
            function renderGroupManagement() {
                toggleChatView(false); // Ensure list is visible on mobile when rendering group management
                appContent.innerHTML = `
                    <h2 class="mb-4 text-center"><i class="fas fa-users-cog"></i> Gestion des Groupes</h2>
                    <div class="card p-4 shadow-sm mb-4">
                        <h5>Créer un nouveau groupe</h5>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" placeholder="Nom du nouveau groupe" id="newGroupNameInput">
                            <button class="btn btn-primary" id="createGroupBtn">Créer le groupe</button>
                        </div>
                    </div>

                    <h3 class="mb-3">Vos Groupes</h3>
                    <div id="groupsManagementList" class="list-group">
                        </div>
                `;
                hideContactDetailsSidebar(); // Ensure sidebar is hidden when rendering group management

                const newGroupNameInput = document.getElementById('newGroupNameInput');
                const createGroupBtn = document.getElementById('createGroupBtn');
                const groupsManagementListElement = document.getElementById('groupsManagementList');

                createGroupBtn.addEventListener('click', () => {
                    const groupName = newGroupNameInput.value.trim();
                    if (groupName) {
                        createGroup(groupName);
                        newGroupNameInput.value = '';
                        renderGroupManagement(); // Re-render pour afficher le nouveau groupe et ses options
                        showToast('Groupe créé avec succès !', 'success');
                    } else {
                        showToast('Veuillez entrer un nom pour le groupe.', 'warning');
                    }
                });

                displayGroupsForManagement(); // Appelle une fonction d'aide pour afficher les groupes

                function displayGroupsForManagement() {
                    groupsManagementListElement.innerHTML = '';
                    if (Object.keys(groupsData).length === 0) {
                        groupsManagementListElement.innerHTML = `<p class="text-center text-muted">Aucun groupe créé pour le moment. Créez-en un !</p>`;
                        return;
                    }

                    Object.keys(groupsData).forEach(groupId => {
                        const group = groupsData[groupId];
                        // Récupérer les noms des membres ou afficher "ID Inconnu" si le contact n'existe pas
                        const groupMembersNames = group.members.map(memberId => contactsData[memberId] ? contactsData[memberId].name : `ID Inconnu: ${memberId}`).join(', ');

                        const groupHtml = `
                            <div class="list-group-item mb-3 p-3 shadow-sm rounded">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${group.name}</h5>
                                    <small class="text-muted">${group.members.length} membres</small>
                                </div>
                                <p class="mb-2">Membres: ${groupMembersNames || 'Aucun'}</p>
                                <div class="d-flex align-items-center mb-2">
                                    <select class="form-select form-select-sm me-2 add-member-select" data-group-id="${groupId}">
                                        <option value="">Ajouter un membre...</option>
                                        ${Object.keys(contactsData).map(contactId => {
                                            const contact = contactsData[contactId];
                                            return `<option value="${contactId}" ${group.members.includes(contactId) ? 'disabled' : ''}>${contact.name}</option>`;
                                        }).join('')}
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary add-member-btn" data-group-id="${groupId}">Ajouter</button>
                                </div>
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    ${group.members.map(memberId => {
                                        const member = contactsData[memberId];
                                        return member ? `
                                            <span class="badge bg-info text-dark d-flex align-items-center">
                                                ${member.name}
                                                <button type="button" class="btn-close btn-close-white ms-1 remove-member-btn" data-group-id="${groupId}" data-member-id="${memberId}" aria-label="Supprimer"></button>
                                            </span>` : '';
                                    }).join('')}
                                </div>
                                <button type="button" class="btn btn-danger btn-sm mt-3 delete-group-btn" data-group-id="${groupId}"><i class="fas fa-trash"></i> Supprimer le groupe</button>
                            </div>
                        `;
                        groupsManagementListElement.insertAdjacentHTML('beforeend', groupHtml);
                    });

                    attachGroupManagementListeners();
                }

                function createGroup(name) {
                    const newGroupId = 'group-' + Math.random().toString(36).substr(2, 9);
                    groupsData[newGroupId] = {
                        id: newGroupId,
                        name: name,
                        members: [],
                        messages: [] // Initialize messages array for group chat
                    };
                    saveGroups();
                }

                function addMemberToGroup(groupId, contactId) {
                    if (groupsData[groupId] && contactsData[contactId]) {
                        if (!groupsData[groupId].members.includes(contactId)) {
                            groupsData[groupId].members.push(contactId);
                            saveGroups();
                            renderGroupManagement(); // Re-render pour mettre à jour la liste
                            showToast(`${contactsData[contactId].name} ajouté à ${groupsData[groupId].name}`, 'success');
                        } else {
                            showToast(`${contactsData[contactId].name} est déjà membre de ce groupe.`, 'info');
                        }
                    } else {
                        showToast('Erreur: Groupe ou contact introuvable.', 'danger');
                    }
                }

                function removeMemberFromGroup(groupId, contactId) {
                    if (groupsData[groupId]) {
                        groupsData[groupId].members = groupsData[groupId].members.filter(member => member !== contactId);
                        saveGroups();
                        renderGroupManagement(); // Re-render pour mettre à jour la liste
                        showToast(`${contactsData[contactId].name} retiré de ${groupsData[groupId].name}`, 'info');
                    } else {
                        showToast('Erreur: Groupe introuvable.', 'danger');
                    }
                }

                function deleteGroup(groupId) {
                    // Utilisation d'une modale personnalisée au lieu de confirm()
                    const confirmationModalHtml = `
                        <div class="modal fade" id="deleteGroupConfirmModal" tabindex="-1" aria-labelledby="deleteGroupConfirmModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header bg-danger text-white">
                                        <h5 class="modal-title" id="deleteGroupConfirmModalLabel">Confirmer la suppression</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        Êtes-vous sûr de vouloir supprimer le groupe "${groupsData[groupId].name}" ? Cette action est irréversible.
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                        <button type="button" class="btn btn-danger" id="confirmDeleteGroupBtn">Supprimer</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', confirmationModalHtml);
                    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteGroupConfirmModal'));
                    deleteConfirmModal.show();

                    document.getElementById('confirmDeleteGroupBtn').addEventListener('click', () => {
                        delete groupsData[groupId];
                        saveGroups();
                        renderGroupManagement(); // Re-render pour mettre à jour la liste
                        showToast('Groupe supprimé !', 'success');
                        deleteConfirmModal.hide();
                        document.getElementById('deleteGroupConfirmModal').remove(); // Supprimer la modale du DOM
                    });

                    // Nettoyer la modale quand elle est fermée sans confirmation
                    document.getElementById('deleteGroupConfirmModal').addEventListener('hidden.bs.modal', function (event) {
                        event.target.remove();
                    });
                }


                function attachGroupManagementListeners() {
                    document.querySelectorAll('.add-member-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const groupId = event.target.dataset.groupId;
                            const selectElement = document.querySelector(`.add-member-select[data-group-id="${groupId}"]`);
                            const contactId = selectElement.value;
                            if (contactId) {
                                addMemberToGroup(groupId, contactId);
                                selectElement.value = ''; // Réinitialiser le sélecteur
                            } else {
                                showToast('Veuillez sélectionner un membre à ajouter.', 'warning');
                            }
                        });
                    });

                    document.querySelectorAll('.remove-member-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const groupId = event.target.dataset.groupId;
                            const memberId = event.target.dataset.memberId;
                            removeMemberFromGroup(groupId, memberId);
                        });
                    });

                    document.querySelectorAll('.delete-group-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const groupId = event.target.dataset.groupId;
                            deleteGroup(groupId);
                        });
                    });
                }
            }

            /**
             * Affiche la liste des conversations de groupe.
             */
            function renderGroupChatList() {
                toggleChatView(false); // Ensure list is visible on mobile when rendering group chats
                appContent.innerHTML = `
                    <h2 class="mb-4 text-center"><i class="fas fa-comments"></i> Conversations de Groupes</h2>
                    <div class="contacts-layout">
                        <div class="contacts-list" id="groupChatsList">
                            </div>
                        <div class="chat-window" id="chatWindow">
                            <div class="chat-placeholder">
                                <i class="fas fa-users"></i>
                                <h3>Sélectionnez un groupe pour commencer à discuter</h3>
                                <p>Les conversations de groupe s'afficheront ici.</p>
                            </div>
                        </div>
                        <div class="contact-details-sidebar" id="contactDetailsSidebar">
                            </div>
                    </div>
                `;
                // Get the sidebar element once DOM is loaded for the chat view
                contactDetailsSidebar = document.getElementById('contactDetailsSidebar');
                hideContactDetailsSidebar(); // Ensure it's hidden initially for this view

                const groupChatsListElement = document.getElementById('groupChatsList');
                if (Object.keys(groupsData).length === 0) {
                    groupChatsListElement.innerHTML = `<p class="text-center text-muted p-3">Aucun groupe de conversation créé pour le moment. Créez-en un via "Gestion des groupes" !</p>`;
                    return;
                }

                Object.keys(groupsData).forEach(groupId => {
                    const group = groupsData[groupId];
                    const groupItemHtml = `
                        <div class="contact-item" data-group-id="${groupId}">
                            <img src="https://placehold.co/40x40/0084ff/ffffff?text=${group.name.charAt(0).toUpperCase()}" alt="Groupe ${group.name}" style="border-radius: 50%; object-fit: cover; margin-right: 10px;">
                            <div class="contact-info">
                                <h6>${group.name}</h6>
                                <p>${truncateText(group.messages && group.messages.length > 0 ? group.messages[group.messages.length - 1].content : 'Aucun message', 50)}</p>
                            </div>
                        </div>
                    `;
                    groupChatsListElement.insertAdjacentHTML('beforeend', groupItemHtml);
                });

                // Attacher les écouteurs d'événements aux éléments de groupe
                document.querySelectorAll('#groupChatsList .contact-item').forEach(item => {
                    item.addEventListener('click', (event) => {
                        const selectedGroupId = event.currentTarget.dataset.groupId;
                        renderGroupChatWindow(selectedGroupId);

                        // Mettre à jour la classe active
                        document.querySelectorAll('#groupChatsList .contact-item').forEach(c => c.classList.remove('active'));
                        event.currentTarget.classList.add('active');
                    });
                });
                console.log('Liste des conversations de groupe affichée.');
            }


            /**
             * Affiche la fenêtre de chat pour un groupe donné.
             * @param {string} groupId - L'ID du groupe à afficher.
             */
            function renderGroupChatWindow(groupId) {
                currentChatContactId = groupId; // Store group ID here
                currentChatType = 'group';
                const group = groupsData[groupId];
                const chatWindowElement = document.getElementById('chatWindow');

                if (!group) {
                    chatWindowElement.innerHTML = `<p class="text-danger text-center">Groupe non trouvé.</p>`;
                    return;
                }

                chatWindowElement.innerHTML = `
                    <div class="chat-header" id="chatHeader">
                        <button class="back-button" id="backToGroupListBtn"><i class="fas fa-arrow-left"></i></button>
                        <img src="https://placehold.co/50x50/0084ff/ffffff?text=${group.name.charAt(0).toUpperCase()}" alt="Groupe ${group.name}" style="border-radius: 50%; object-fit: cover; margin-right: 15px;">
                        <h5>${group.name}
                            <small class="ms-2">(${group.members.length} membres)</small>
                        </h5>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        </div>
                    <div class="chat-input-area">
                        <input type="text" class="form-control" placeholder="Écrire un message..." id="messageInput">
                        <button class="btn btn-primary" id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                `;

                const chatMessagesElement = document.getElementById('chatMessages');
                const messageInput = document.getElementById('messageInput');
                const sendMessageBtn = document.getElementById('sendMessageBtn');
                const backToGroupListBtn = document.getElementById('backToGroupListBtn');
                const chatHeaderElement = document.getElementById('chatHeader');

                backToGroupListBtn.addEventListener('click', () => {
                    renderGroupChatList(); // Go back to the group list
                    hideContactDetailsSidebar(); // Hide sidebar when going back
                });

                // Add event listener to the chat header for group details
                chatHeaderElement.addEventListener('click', (event) => {
                    // Ensure click is not on the back button
                    if (!event.target.closest('.back-button')) {
                        showGroupDetailsSidebar(groupId);
                    }
                });


                // Afficher les messages existants du groupe
                group.messages.forEach(msg => {
                    // For group messages, prepend sender's name if not 'me'
                    const senderName = msg.type === 'me' ? 'Moi' : (contactsData[msg.senderId]?.name || 'Membre inconnu');
                    displayMessage(msg.type, msg.content, msg.time, chatMessagesElement, senderName);
                });
                scrollToBottom(chatMessagesElement);

                // Écouteur pour envoyer un message de groupe
                sendMessageBtn.addEventListener('click', () => {
                    sendGroupMessage(messageInput.value, groupId, chatMessagesElement, messageInput);
                });

                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendGroupMessage(messageInput.value, groupId, chatMessagesElement, messageInput);
                    }
                });
                toggleChatView(true); // Activate chat view on mobile
                hideContactDetailsSidebar(); // Ensure sidebar is hidden when a new group chat opens
                console.log('Fenêtre de chat affichée pour le groupe:', group.name);
            }

            /**
             * Envoie un message de groupe et le gère.
             * @param {string} messageText - Le texte du message à envoyer.
             * @param {string} groupId - L'ID du groupe.
             * @param {HTMLElement} chatMessagesElement - L'élément conteneur des messages.
             * @param {HTMLInputElement} messageInput - L'élément input du message.
             */
            function sendGroupMessage(messageText, groupId, chatMessagesElement, messageInput) {
                if (messageText.trim() === '') return;

                const group = groupsData[groupId];
                const currentTime = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                // Assuming "me" is the current user. For a real app, you'd have a user ID.
                const currentUserContactId = "johnDoe"; // Example: assuming "johnDoe" is the current user
                const currentUser = contactsData[currentUserContactId];

                const groupMessage = {
                    type: "me", // The message is sent by "me" (the current user)
                    contentType: "text",
                    content: messageText.trim(),
                    time: currentTime,
                    senderId: currentUserContactId // Store the ID of the sender
                };

                group.messages.push(groupMessage);
                // For group messages, prepend sender's name if not 'me'
                const senderName = groupMessage.type === 'me' ? 'Moi' : (contactsData[groupMessage.senderId]?.name || 'Membre inconnu');
                displayMessage(groupMessage.type, groupMessage.content, groupMessage.time, chatMessagesElement, senderName);
                
                group.lastMessage = messageText.trim(); // Update last message for the group
                
                messageInput.value = ''; // Clear input
                scrollToBottom(chatMessagesElement);
                saveGroups(); // Save updated group data
            }

            // --- Profile Management Functions ---

            /**
             * Renders the user profile editing page.
             */
            function renderProfilePage() {
                appContent.innerHTML = `
                    <h2 class="mb-4 text-center"><i class="fas fa-user-circle"></i> Mon Profil</h2>
                    <div class="card profile-card">
                        <form id="profileForm">
                            <div class="text-center mb-4">
                                <div class="profile-avatar-container">
                                    <img id="profileAvatar" src="https://placehold.co/120x120/cccccc/ffffff?text=Avatar" alt="Profile Avatar">
                                    <label for="avatarUpload" class="upload-icon">
                                        <i class="fas fa-camera"></i>
                                    </label>
                                    <input type="file" id="avatarUpload" accept="image/*" class="d-none">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="profileName" class="form-label">Nom complet</label>
                                <input type="text" class="form-control" id="profileName" required>
                            </div>
                            <div class="mb-3">
                                <label for="profileEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="profileEmail" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save"></i> Enregistrer les modifications</button>
                            </div>
                        </form>
                    </div>
                `;
                loadProfileDataAndPopulateForm(); // Load existing profile data and populate form
                attachProfileListeners(); // Attach event listeners for the profile page
                hideContactDetailsSidebar(); // Ensure sidebar is hidden when rendering profile page
                console.log('Page de profil affichée.');
            }

            /**
             * Loads user profile data from localStorage and populates the form.
             */
            function loadProfileDataAndPopulateForm() {
                const profileData = JSON.parse(localStorage.getItem('userProfile')) || {
                    name: 'Utilisateur JJ-Commerce',
                    email: 'utilisateur@jjcommerce.com',
                    avatar: 'https://placehold.co/120x120/cccccc/ffffff?text=Avatar'
                };

                document.getElementById('profileName').value = profileData.name;
                document.getElementById('profileEmail').value = profileData.email;
                document.getElementById('profileAvatar').src = profileData.avatar;
                console.log('Données de profil chargées et formulaire rempli:', profileData);
            }

            /**
             * Attaches event listeners for the profile page elements.
             */
            function attachProfileListeners() {
                document.getElementById('profileForm').addEventListener('submit', saveProfileData);
                document.getElementById('avatarUpload').addEventListener('change', handleAvatarUpload);
                console.log('Écouteurs de profil attachés.');
            }

            /**
             * Handles the submission of the profile form, saving data to localStorage.
             * @param {Event} event - The submit event.
             */
            function saveProfileData(event) {
                event.preventDefault();
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const avatar = document.getElementById('profileAvatar').src; // Get current avatar src

                const updatedProfile = { name, email, avatar };
                localStorage.setItem('userProfile', JSON.stringify(updatedProfile));
                showToast('Profil enregistré avec succès !', 'success');
                console.log('Profil enregistré:', updatedProfile);
                updateHeaderProfile(); // Update header after saving profile
            }

            /**
             * Handles the simulated avatar upload.
             * In a real app, this would involve sending the file to a server.
             * Here, it just updates the image source with a placeholder.
             * @param {Event} event - The change event from the file input.
             */
            function handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // In a real app, you'd upload this e.target.result (base64) to a server
                        // and get a permanent URL. For this demo, we'll just use it directly.
                        document.getElementById('profileAvatar').src = e.target.result;
                        showToast('Image de profil mise à jour !', 'info');
                        console.log('Nouvel avatar sélectionné.');
                    };
                    reader.readAsDataURL(file); // Reads the file as a Base64 string
                }
            }

            /**
             * Updates the profile picture and username in the header.
             */
            function updateHeaderProfile() {
                const profileData = JSON.parse(localStorage.getItem('userProfile')) || {
                    name: 'Utilisateur JJ-Commerce',
                    email: 'utilisateur@jjcommerce.com',
                    avatar: 'https://placehold.co/120x120/cccccc/ffffff?text=Avatar'
                };

                const headerProfileAvatar = document.getElementById('headerProfileAvatar');
                const headerUsername = document.getElementById('headerUsername');

                if (headerProfileAvatar) {
                    headerProfileAvatar.src = profileData.avatar;
                    // Fallback for broken images
                    headerProfileAvatar.onerror = function() {
                        this.onerror=null;
                        this.src='https://placehold.co/30x30/cccccc/ffffff?text=U';
                    };
                }
                if (headerUsername) {
                    headerUsername.textContent = profileData.name;
                }
                console.log('En-tête du profil mis à jour.');
            }

            /**
             * Affiche la barre latérale des détails du contact.
             * @param {string} contactId - L'ID du contact à afficher les détails.
             */
            function showContactDetailsSidebar(contactId) {
                const contact = contactsData[contactId];
                if (!contact) {
                    console.error('Contact non trouvé pour la barre latérale des détails:', contactId);
                    return;
                }

                if (!contactDetailsSidebar) {
                    console.error('L\'élément contactDetailsSidebar n\'est pas trouvé.');
                    return;
                }

                contactDetailsSidebar.innerHTML = `
                    <div class="header">
                        <button class="close-btn" id="closeContactDetailsBtn"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="text-center">
                        <img src="${contact.avatar}" alt="${contact.name}" class="avatar" onerror="this.onerror=null;this.src='https://placehold.co/100x100/0084ff/ffffff?text=${contact.name.charAt(0)}'">
                        <h5>${contact.name}</h5>
                        <p class="status">${contact.status === 'online' ? 'En ligne' : 'Hors ligne'}</p>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-comment-dots"></i> <strong>Dernier message:</strong> ${truncateText(contact.lastMessage, 60)}
                    </div>
                    ${contact.isAI ? `
                    <div class="info-item">
                        <i class="fas fa-robot"></i> <strong>Type:</strong> Intelligence Artificielle
                    </div>
                    ` : ''}
                    <div class="info-item">
                        <i class="fas fa-info-circle"></i> <strong>ID:</strong> ${contactId}
                    </div>
                    `;

                contactDetailsSidebar.classList.add('active');
                document.querySelector('.contacts-layout').classList.add('sidebar-active'); // Add class to parent to adjust layout

                document.getElementById('closeContactDetailsBtn').addEventListener('click', hideContactDetailsSidebar);
                console.log('Barre latérale des détails du contact affichée pour:', contact.name);
            }

            /**
             * Affiche la barre latérale des détails du groupe.
             * @param {string} groupId - L'ID du groupe à afficher les détails.
             */
            function showGroupDetailsSidebar(groupId) {
                const group = groupsData[groupId];
                if (!group) {
                    console.error('Groupe non trouvé pour la barre latérale des détails:', groupId);
                    return;
                }

                if (!contactDetailsSidebar) {
                    console.error('L\'élément contactDetailsSidebar n\'est pas trouvé.');
                    return;
                }

                const memberListHtml = group.members.map(memberId => {
                    const member = contactsData[memberId];
                    return member ? `
                        <li class="list-group-item d-flex align-items-center">
                            <img src="${member.thumbnail}" alt="${member.name}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;" onerror="this.onerror=null;this.src='https://placehold.co/30x30/cccccc/ffffff?text=${member.name.charAt(0)}'">
                            ${member.name}
                            <span class="status-dot ${member.status === 'offline' ? 'offline' : ''} ms-auto"></span>
                        </li>
                    ` : '';
                }).join('');

                contactDetailsSidebar.innerHTML = `
                    <div class="header">
                        <button class="close-btn" id="closeContactDetailsBtn"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="text-center">
                        <img src="https://placehold.co/100x100/0084ff/ffffff?text=${group.name.charAt(0).toUpperCase()}" alt="Groupe ${group.name}" class="avatar">
                        <h5>${group.name}</h5>
                        <p class="status">${group.members.length} membres</p>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-info-circle"></i> <strong>ID du groupe:</strong> ${groupId}
                    </div>
                    <div class="info-item">
                        <strong>Membres:</strong>
                        <ul class="list-group list-group-flush mt-2">
                            ${memberListHtml || '<li class="list-group-item text-muted">Aucun membre</li>'}
                        </ul>
                    </div>
                `;

                contactDetailsSidebar.classList.add('active');
                document.querySelector('.contacts-layout').classList.add('sidebar-active');

                document.getElementById('closeContactDetailsBtn').addEventListener('click', hideContactDetailsSidebar);
                console.log('Barre latérale des détails du groupe affichée pour:', group.name);
            }


            /**
             * Cache la barre latérale des détails du contact.
             */
            function hideContactDetailsSidebar() {
                if (contactDetailsSidebar) {
                    contactDetailsSidebar.classList.remove('active');
                    document.querySelector('.contacts-layout').classList.remove('sidebar-active');
                    console.log('Barre latérale des détails du contact cachée.');
                }
            }


            // --- Écouteurs d'événements globaux ---
            // Ouvre la modale du panier et met à jour son contenu
            cartBtn.addEventListener('click', () => {
                console.log('Bouton panier cliqué.');
                renderCartItems();
                cartModal.show();
            });

            // Passe du panier au formulaire de commande
            checkoutBtn.addEventListener('click', () => {
                console.log('Bouton "Passer la commande" cliqué.');
                cartModal.hide(); // Ferme la modale du panier
                renderCheckoutForm(); // Affiche le formulaire de commande
            });

            // Navigue vers la page d'accueil (produits)
            // Lorsque le logo JJ-Commerce est cliqué, il agit comme le lien "Accueil"
            document.querySelector('.navbar-brand').addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Logo JJ-Commerce cliqué. Redirection vers l\'accueil.');
                searchInput.value = ''; // Efface la barre de recherche desktop
                searchInputMobile.value = ''; // Efface la barre de recherche mobile
                renderProducts(); // Affiche tous les produits
                // Gère la classe 'active' pour la navigation
                document.querySelectorAll('.navbar-nav .nav-link').forEach(link => link.classList.remove('active'));
                homeLink.classList.add('active');
            });

            homeLink.addEventListener('click', (e) => {
                e.preventDefault(); // Empêche le comportement par défaut du lien
                console.log('Lien "Accueil" cliqué.');
                searchInput.value = ''; // Efface la barre de recherche desktop
                searchInputMobile.value = ''; // Efface la barre de recherche mobile
                renderProducts(); // Affiche tous les produits
                // Gère la classe 'active' pour la navigation
                document.querySelectorAll('.navbar-nav .nav-link').forEach(link => link.classList.remove('active'));
                homeLink.classList.add('active');
            });

            // Navigue vers la page de l'historique des commandes
            orderHistoryLink.addEventListener('click', (e) => {
                e.preventDefault(); // Empêche le comportement par défaut du lien
                console.log('Lien "Mes Commandes" cliqué.');
                renderOrderHistory();
                // Gère la classe 'active' pour la navigation
                document.querySelectorAll('.navbar-nav .nav-link').forEach(link => link.classList.remove('active'));
                orderHistoryLink.classList.add('active');
            });

            // Sidebar link event listeners
            if (sidebarCategoriesLink) {
                sidebarCategoriesLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Sidebar: Catégories cliqué.');
                    renderProducts(); // Pour l'instant, affiche tous les produits
                });
            }
            if (sidebarFavoritesLink) {
                sidebarFavoritesLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Sidebar: Favoris cliqué.');
                    appContent.innerHTML = `<h2 class="text-center mt-5">Section Favoris (à implémenter)</h2><p class="text-center">Vos produits favoris seront affichés ici.</p>`;
                    hideContactDetailsSidebar(); // Ensure sidebar is hidden
                });
            }
            if (sidebarGroupChatsLink) {
                sidebarGroupChatsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Sidebar: Groupes (Conversations) cliqué.');
                    renderGroupChatList(); // Affiche la liste des conversations de groupe
                });
            }
            if (sidebarGroupManagementLink) {
                sidebarGroupManagementLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Sidebar: Gestion des groupes cliqué.');
                    renderGroupManagement(); // Affiche la section de gestion des groupes
                });
            }
            if (sidebarContactsLink) {
                sidebarContactsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Sidebar: Contacts cliqué.');
                    renderContacts(); // Affiche la nouvelle section contacts
                });
            }
            if (sidebarProfileLink) {
                sidebarProfileLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Sidebar: Mon Profil cliqué.');
                    renderProfilePage(); // Affiche la page de gestion de profil
                });
            }

            // Make the header profile display clickable
            const headerProfileLink = document.getElementById('headerProfileLink');
            if (headerProfileLink) {
                headerProfileLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderProfilePage();
                });
            }

            // Mobile profile link
            const mobileProfileLink = document.getElementById('mobileProfileLink');
            if (mobileProfileLink) {
                mobileProfileLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderProfilePage();
                    // Close navbar on mobile after clicking link
                    const navbarCollapse = document.getElementById('navbarNav');
                    const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                });
            }


            // Écouteur pour la recherche instantanée (desktop)
            searchInput.addEventListener('keyup', (e) => {
                filterProducts(e.target.value);
            });

            // Écouteur pour la recherche instantanée (mobile)
            searchInputMobile.addEventListener('keyup', (e) => {
                filterProducts(e.target.value);
            });

            // --- Initialisation de l'application ---
            updateCartCount(); // Met à jour le compteur du panier au chargement
            renderProducts(); // Charge les produits et affiche la page d'accueil au démarrage
            updateHeaderProfile(); // Call new function to update header profile
            console.log('Application JJ-Commerce initialisée.');
        });
    </script>
</body>
</html>
